services:
  akari-db:
    image: postgres:18.1@sha256:bfe50b2b0ddd9b55eadedd066fe24c7c6fe06626185b73358c480ea37868024d
    container_name: akari-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      NOCODB_DB: ${NOCODB_DB:-nocodb}
      TZ: UTC
    volumes:
      - db-store:/var/lib/postgresql
      - ./init-db:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  akari-migrate:
    build:
      context: .
      dockerfile: akari/Dockerfile.migrate
    container_name: akari-migrate
    restart: "no"
    depends_on:
      akari-db:
        condition: service_healthy
    environment:
      ENV: production
      POSTGRES_HOST: akari-db
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_SSLMODE: ${POSTGRES_SSLMODE}

  akari:
    build:
      context: .
      dockerfile: akari/Dockerfile
    container_name: akari
    restart: unless-stopped
    depends_on:
      akari-db:
        condition: service_healthy
      akari-migrate:
        condition: service_completed_successfully
    volumes:
      - ./secrets/akari-sa-key.json:/app/secrets/akari-sa-key.json
    environment:
      ENV: production
      # Database
      POSTGRES_HOST: akari-db
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_SSLMODE: ${POSTGRES_SSLMODE}
      POSTGRES_MAX_OPEN_CONNS: ${POSTGRES_MAX_OPEN_CONNS}
      POSTGRES_MAX_IDLE_CONNS: ${POSTGRES_MAX_IDLE_CONNS}
      POSTGRES_CONN_MAX_LIFETIME_MINUTES: ${POSTGRES_CONN_MAX_LIFETIME_MINUTES}
      POSTGRES_CONN_MAX_IDLE_TIME_MINUTES: ${POSTGRES_CONN_MAX_IDLE_TIME_MINUTES}
      # LLM
      LLM_PROJECT_ID: ${LLM_PROJECT_ID}
      LLM_LOCATION: ${LLM_LOCATION}
      LLM_MODEL_NAME: ${LLM_MODEL_NAME}
      # Log
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FORMAT: ${LOG_FORMAT}
      # Discord
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      DISCORD_READY_TIMEOUT: ${DISCORD_READY_TIMEOUT}
      # Others
      GOOGLE_APPLICATION_CREDENTIALS: /app/secrets/akari-sa-key.json
    healthcheck:
      test: ["CMD", "pgrep", "-f", "akari"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  nocodb:
    image: nocodb/nocodb:0.265.1@sha256:8fd57018accf775fb5390392910e4b0ef6bb154f17c5732b478eb76c40ee8d1e
    container_name: nocodb
    restart: unless-stopped
    depends_on:
      akari-db:
        condition: service_healthy
    environment:
      NOCODB_DB: ${NOCODB_DB:-nocodb}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      NC_DB: "pg://akari-db:5432?u=${POSTGRES_USER}&p=${POSTGRES_PASSWORD}&d=${NOCODB_DB:-nocodb}"
      NC_AUTH_JWT_SECRET: ${NC_AUTH_JWT_SECRET}
      NC_SENTRY_DSN: ${NC_SENTRY_DSN:-}
      NC_DISABLE_TELE: ${NC_DISABLE_TELE:-true}

  cloudflare-tunnel:
    image: cloudflare/cloudflared:2025.11.1@sha256:89ee50efb1e9cb2ae30281a8a404fed95eb8f02f0a972617526f8c5b417acae2
    container_name: cloudflare-tunnel
    restart: unless-stopped
    command: tunnel run
    environment:
      TUNNEL_TOKEN: ${CLOUDFLARE_TUNNEL_TOKEN}
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  db-store:
    driver: local
