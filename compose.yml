services:
  akari-db:
    image: postgres:18.1@sha256:bfe50b2b0ddd9b55eadedd066fe24c7c6fe06626185b73358c480ea37868024d
    container_name: akari-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      TZ: UTC
    volumes:
      - db-store:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  akari-migrate:
    build:
      context: .
      dockerfile: akari/Dockerfile.migrate
    container_name: akari-migrate
    restart: "no"
    depends_on:
      akari-db:
        condition: service_healthy
    environment:
      ENV: production
      POSTGRES_HOST: akari-db
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_SSLMODE: ${POSTGRES_SSLMODE}
    profiles:
      - migrate

  akari:
    build:
      context: .
      dockerfile: akari/Dockerfile
    container_name: akari
    restart: unless-stopped
    depends_on:
      akari-db:
        condition: service_healthy
    volumes:
      - ./secrets/akari-sa-key.json:/app/secrets/akari-sa-key.json
    environment:
      ENV: production
      # Database
      POSTGRES_HOST: akari-db
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_SSLMODE: ${POSTGRES_SSLMODE}
      POSTGRES_MAX_OPEN_CONNS: ${POSTGRES_MAX_OPEN_CONNS}
      POSTGRES_MAX_IDLE_CONNS: ${POSTGRES_MAX_IDLE_CONNS}
      POSTGRES_CONN_MAX_LIFETIME_MINUTES: ${POSTGRES_CONN_MAX_LIFETIME_MINUTES}
      POSTGRES_CONN_MAX_IDLE_TIME_MINUTES: ${POSTGRES_CONN_MAX_IDLE_TIME_MINUTES}
      # LLM
      LLM_PROJECT_ID: ${LLM_PROJECT_ID}
      LLM_LOCATION: ${LLM_LOCATION}
      LLM_MODEL_NAME: ${LLM_MODEL_NAME}
      # Log
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FORMAT: ${LOG_FORMAT}
      # Discord
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      DISCORD_READY_TIMEOUT: ${DISCORD_READY_TIMEOUT}
      # Akari
      DISCORD_BOTNAMEREGEXP: ${DISCORD_BOTNAMEREGEXP}
      # Others
      GOOGLE_APPLICATION_CREDENTIALS: /app/secrets/akari-sa-key.json
    healthcheck:
      test: ["CMD", "pgrep", "-f", "akari"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  db-store:
    driver: local
