openapi: 3.0.0
info:
  title: Kiseki API
  description: API specification for Kiseki service
  version: 0.1.0
  contact:
    name: Kizuna Organization
    url: https://github.com/kizuna-org

servers:
  - url: http://localhost:8080
    description: Development server

tags:
  - name: Health
    description: Health check endpoint
  - name: Character
    description: Character management endpoints
  - name: Memory
    description: Memory management endpoints

paths:
  /health:
    get:
      tags:
        - Health
      operationId: getMemoryHealth
      summary: Memory service health check
      description: Returns the health status of the memory service
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /characters:
    get:
      tags:
        - Character
      operationId: listCharacters
      summary: List all characters
      description: Retrieve a list of all characters
      responses:
        "200":
          description: List of characters retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CharacterListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      tags:
        - Character
      operationId: createCharacter
      summary: Create a new character
      description: Create a new character with the specified name
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCharacterRequest"
      responses:
        "201":
          description: Character created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Character"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /characters/{characterId}:
    get:
      tags:
        - Character
      operationId: getCharacter
      summary: Get a character by ID
      description: Retrieve details of a specific character
      parameters:
        - $ref: "#/components/parameters/CharacterIdPath"
      responses:
        "200":
          description: Character retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Character"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      tags:
        - Character
      operationId: updateCharacter
      summary: Update a character
      description: Update an existing character's information
      parameters:
        - $ref: "#/components/parameters/CharacterIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateCharacterRequest"
      responses:
        "200":
          description: Character updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Character"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags:
        - Character
      operationId: deleteCharacter
      summary: Delete a character
      description: Delete a character by ID
      parameters:
        - $ref: "#/components/parameters/CharacterIdPath"
      responses:
        "204":
          description: Character deleted successfully
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /characters/{characterId}/memory:
    get:
      tags:
        - Memory
      operationId: getMemoryIO
      summary: Retrieve memory data
      description: Get memory data by type
      parameters:
        - $ref: "#/components/parameters/CharacterIdPath"
        - name: dType
          in: query
          required: true
          description: Data type identifier
          schema:
            $ref: "#/components/schemas/DType"
        - name: data
          in: query
          required: true
          description: Data identifier or value
          schema:
            type: string
      responses:
        "200":
          description: Memory data retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemoryIOResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      tags:
        - Memory
      operationId: putMemoryIO
      summary: Store memory data
      description: Store data in memory with specified type
      parameters:
        - $ref: "#/components/parameters/CharacterIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MemoryIORequest"
      responses:
        "204":
          description: Memory data stored successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /characters/{characterId}/sleep:
    post:
      tags:
        - Memory
      operationId: postMemorySleep
      summary: Sleep memory service
      description: Put the memory service into sleep mode
      parameters:
        - $ref: "#/components/parameters/CharacterIdPath"
      responses:
        "200":
          description: Memory service sleeping
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemorySleepResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /characters/{characterId}/task:
    post:
      tags:
        - Memory
      operationId: postMemoryPolling
      summary: Task processing endpoint
      description: Submit task results and receive new task requests
      parameters:
        - $ref: "#/components/parameters/CharacterIdPath"
      requestBody:
        required: true
        description: Task results from completed operations
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MemoryPollingRequest"
      responses:
        "200":
          description: New task requests to be processed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemoryPollingResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

components:
  parameters:
    UserId:
      name: userId
      in: path
      required: true
      description: User ID
      schema:
        type: string
        format: uuid

    CharacterIdPath:
      name: characterId
      in: path
      required: true
      description: Character ID
      schema:
        type: string
        format: uuid

  schemas:
    HealthResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum:
            - healthy
            - degraded
            - unhealthy
        timestamp:
          type: string
          format: date-time
        version:
          type: string

    DType:
      type: string
      description: Data type identifier
      enum:
        - text

    Meta:
      type: object
      description: Metadata object with timestamps
      required:
        - memorized_at
        - created_at
        - updated_at
      properties:
        memorized_at:
          type: string
          format: date-time
          description: Timestamp when the data was memorized
        created_at:
          type: string
          format: date-time
          description: Timestamp when the data was created
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the data was last updated
      additionalProperties: true

    BaseData:
      type: object
      description: Base data structure with dType and data
      required:
        - dType
        - data
      properties:
        dType:
          $ref: "#/components/schemas/DType"
        data:
          description: Typed data value
          oneOf:
            - type: string

    DataFragment:
      allOf:
        - $ref: "#/components/schemas/BaseData"
        - type: object
          description: Data fragment without metadata (used in requests)

    Fragment:
      allOf:
        - $ref: "#/components/schemas/BaseData"
        - type: object
          description: Data fragment with metadata (used in responses)
          required:
            - meta
          properties:
            meta:
              $ref: "#/components/schemas/Meta"

    MemoryIORequest:
      allOf:
        - $ref: "#/components/schemas/DataFragment"
        - type: object
          description: Request to store memory data

    MemoryIOResponse:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          description: Array of memory data fragments with metadata
          items:
            $ref: "#/components/schemas/Fragment"

    MemorySleepRequest:
      type: object
      description: Empty request body

    MemorySleepResponse:
      type: object
      required:
        - pollingUrl
      properties:
        pollingUrl:
          type: string
          format: uri
          description: Polling URL for memory operations

    MemoryPollingRequest:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          description: Array of completed task results
          items:
            $ref: "#/components/schemas/PollingRequestItem"

    MemoryPollingResponse:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          description: Array of new task requests grouped by task type
          items:
            $ref: "#/components/schemas/PollingResponseGroup"

    PollingRequestItem:
      allOf:
        - $ref: "#/components/schemas/DataFragment"
        - type: object
          description: Completed task result
          required:
            - taskId
          properties:
            taskId:
              type: string
              description: Identifier of the completed task

    PollingResponseGroup:
      type: object
      description: Group of new task requests by task type
      required:
        - tType
        - items
      properties:
        tType:
          type: string
          description: Task type for this group
        items:
          type: array
          description: Array of new task requests for this task type
          items:
            $ref: "#/components/schemas/PollingResponseItem"

    PollingResponseItem:
      allOf:
        - $ref: "#/components/schemas/Fragment"
        - type: object
          description: New task request to be processed
          required:
            - taskId
          properties:
            taskId:
              type: string
              description: Identifier for the new task

    WebSocketMessage:
      type: object
      required:
        - tType
        - items
      properties:
        tType:
          type: string
          description: Transaction type enum value
        items:
          type: array
          description: Array of data fragments with metadata
          items:
            $ref: "#/components/schemas/Fragment"

    WebSocketResponse:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          description: Array of response data fragments
          items:
            $ref: "#/components/schemas/DataFragment"

    Character:
      type: object
      required:
        - id
        - name
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Character unique identifier
        name:
          type: string
          description: Character name
          minLength: 1
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the character was created
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the character was last updated

    CreateCharacterRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Character name
          minLength: 1

    UpdateCharacterRequest:
      type: object
      properties:
        name:
          type: string
          description: Character name
          minLength: 1

    CharacterListResponse:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          description: List of characters
          items:
            $ref: "#/components/schemas/Character"

    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
          nullable: true

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            code: INVALID_REQUEST
            message: Invalid request parameters

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            code: NOT_FOUND
            message: Resource not found

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            code: INTERNAL_ERROR
            message: An internal server error occurred
